# üß† Unified Memory System - Complete File Map
*Generated by Agent 6 - Deep Dive Analysis*
*Date: August 12, 2025*

## üéØ Executive Summary

I found the complete unified memory system! It's a sophisticated multi-project memory architecture with cross-agent conversation sharing. Here's every file and component mapped out.

## üìä System Architecture Overview

The unified memory system consists of **4 core components**:
1. **Multi-Project Memory Store** - Cross-project user preferences
2. **Universal Session Manager** - Agent conversation persistence  
3. **LangGraph Integration** - Project-aware agent initialization
4. **Unified Database Tables** - Centralized conversation storage

---

## üóÇÔ∏è CORE UNIFIED MEMORY FILES

### **üìÅ Core Memory Engine**
```
ai-agents/memory/
‚îú‚îÄ‚îÄ multi_project_store.py          # Cross-project memory management
‚îú‚îÄ‚îÄ langgraph_integration.py        # LangGraph project-aware integration  
‚îú‚îÄ‚îÄ __init__.py                      # Memory system initialization
‚îî‚îÄ‚îÄ __pycache__/                     # Compiled Python cache
```

### **üîß Session Management**
```
ai-agents/services/
‚îú‚îÄ‚îÄ universal_session_manager.py    # Universal session persistence for ALL agents
‚îî‚îÄ‚îÄ __pycache__/
    ‚îî‚îÄ‚îÄ universal_session_manager.cpython-312.pyc
```

### **üîó Agent Integration Files**
```
ai-agents/agents/cia/
‚îî‚îÄ‚îÄ unified_integration.py          # CIA agent unified system integration

ai-agents/agents/coia/
‚îú‚îÄ‚îÄ persistent_memory.py            # COIA persistent memory system
‚îú‚îÄ‚îÄ unified_graph.py                # COIA LangGraph unified integration
‚îú‚îÄ‚îÄ unified_state.py                # COIA unified state management
‚îú‚îÄ‚îÄ unified_state_backup.py         # Backup unified state
‚îî‚îÄ‚îÄ unified_state_fixed.py          # Fixed unified state implementation

ai-agents/agents/iris/
‚îî‚îÄ‚îÄ agent_old_non_unified.py        # Old IRIS (non-unified for comparison)
```

### **üåê API Layer**
```
ai-agents/api/
‚îú‚îÄ‚îÄ iris_chat_unified.py            # IRIS unified chat API
‚îî‚îÄ‚îÄ iris_chat_unified_fixed.py      # Fixed IRIS unified chat API

ai-agents/routers/
‚îú‚îÄ‚îÄ unified_coia_api.py              # COIA unified API endpoints
‚îî‚îÄ‚îÄ unified_conversation_api.py     # Universal conversation API
```

---

## üíæ DATABASE TABLES (Unified Schema)

### **Primary Unified Tables**
1. **`unified_conversations`** - Root conversation records across all agents
   - Stores: session_id, agent_type, conversation metadata
   - Used by: CIA, IRIS, COIA, Messaging agents

2. **`unified_messages`** - All message content with rich metadata
   - Stores: sender_type, content, parent_id for threading
   - Supports: user/agent/system messages

3. **`unified_conversation_memory`** - Cross-agent shared facts/preferences
   - Stores: memory_key, memory_value (JSONB), conversation_id
   - Uses: Design preferences, agent state, context summaries

4. **`unified_conversation_participants`** - Multi-party membership + read tracking
   - Stores: participant_id, last_read_cursor, joined_at
   - Enables: Read/unread logic across agents

5. **`unified_message_attachments`** - Normalized file attachments
   - Stores: type, url, name, size, metadata
   - Links to: unified_messages for media/document storage

### **Supporting Memory Tables**
- **`user_memories`** - Cross-project user preferences
- **`project_contexts`** - Project-specific conversation state  
- **`project_summaries`** - AI-generated project summaries

---

## üîç ADAPTER SYSTEM (Cross-Agent Context)

### **Context Adapters** 
```
ai-agents/adapters/
‚îú‚îÄ‚îÄ messaging_context.py            # Messaging agent context adapter
‚îú‚îÄ‚îÄ homeowner_context.py            # Homeowner context aggregation
‚îî‚îÄ‚îÄ contractor_context.py           # Contractor context with privacy filtering
```

**How Adapters Work:**
- Query `unified_conversations` by created_by or session_id
- Aggregate `unified_messages` and memory into context dictionary
- Apply privacy filtering for cross-agent data sharing
- Enable CIA ‚Üí IRIS ‚Üí COIA conversation continuity

---

## üß™ TESTING & VERIFICATION FILES

### **Core System Tests**
```
ai-agents/
‚îú‚îÄ‚îÄ test_cia_unified.py                    # CIA unified system tests
‚îú‚îÄ‚îÄ test_cia_unified_final.py              # Final CIA unified tests
‚îú‚îÄ‚îÄ test_coia_unified_integration.py       # COIA unified integration tests
‚îú‚îÄ‚îÄ test_iris_unified_only.py              # IRIS unified system tests
‚îú‚îÄ‚îÄ test_unified_api_direct.py             # Direct unified API tests
‚îú‚îÄ‚îÄ test_unified_iris_integration.py       # IRIS integration tests
‚îú‚îÄ‚îÄ test_unified_iris_simple.py            # Simple IRIS unified tests
‚îî‚îÄ‚îÄ check_unified_tables.py                # Database table verification
```

### **Memory-Specific Tests**
```
ai-agents/
‚îú‚îÄ‚îÄ test_cia_memory_access.py              # CIA memory access tests
‚îú‚îÄ‚îÄ test_coia_memory_quick.py              # Quick COIA memory tests  
‚îú‚îÄ‚îÄ test_coia_persistent_memory_final.py   # Final COIA memory tests
‚îú‚îÄ‚îÄ test_iris_memory_integration.py        # IRIS memory integration
‚îú‚îÄ‚îÄ test_iris_memory_simple.py             # Simple IRIS memory tests
‚îú‚îÄ‚îÄ test_memory_extraction_only.py         # Memory extraction tests
‚îî‚îÄ‚îÄ test_memory_persistence_complete.py    # Complete memory persistence tests
```

### **Multi-Agent Tests**
```
Root Level:
‚îú‚îÄ‚îÄ test_cia_unified_images.py             # CIA unified with images
‚îú‚îÄ‚îÄ test_cia_unified_simple.py             # Simple CIA unified tests
‚îú‚îÄ‚îÄ test_frontend_unified_complete.py      # Frontend unified integration
‚îú‚îÄ‚îÄ test_homeowner_messaging_unified.py    # Homeowner unified messaging
‚îú‚îÄ‚îÄ test_messaging_agent_unified.py        # Messaging agent unified
‚îú‚îÄ‚îÄ test_unified_api_direct.py             # Direct unified API
‚îî‚îÄ‚îÄ test_unified_image_system_complete.py  # Complete image system
```

---

## üìö DOCUMENTATION FILES

### **Core Documentation**
```
docs/
‚îú‚îÄ‚îÄ meta/UnifiedMemoryMap.md                    # Authoritative unified system map
‚îú‚îÄ‚îÄ HOMEOWNER_AGENT_UNIFIED_INTEGRATION_COMPLETE.md # Homeowner integration
‚îú‚îÄ‚îÄ UNIFIED_IMAGE_ATTACHMENT_SYSTEM_PLAN.md     # Image attachment system
‚îî‚îÄ‚îÄ contractor_team/UNIFIED_API_REFERENCE_FOR_COIA.md # COIA API reference

Root Level:
‚îî‚îÄ‚îÄ UNIFIED_CONVERSATION_MIGRATION_PLAN.md      # Migration planning document
```

### **Agent-Specific Docs**
```
docs/
‚îú‚îÄ‚îÄ AGENT_4_CONTRACTOR_SYSTEM_COMPLETE_MEMORY.md  # Agent 4 memory system
‚îî‚îÄ‚îÄ actual-agents/IRIS-DesignInspirationAssistant.md # IRIS unified system
```

---

## üîÑ DATA FLOW ARCHITECTURE

### **Cross-Agent Memory Flow**
```
1. User Conversation
   ‚Üì
2. Agent (CIA/IRIS/COIA) processes via Universal Session Manager
   ‚Üì  
3. Creates/Updates unified_conversations (by session_id)
   ‚Üì
4. Saves unified_messages (user + agent responses)
   ‚Üì
5. Persists unified_conversation_memory (facts, preferences, state)
   ‚Üì
6. Other agents access via Adapters (privacy-filtered context)
   ‚Üì
7. Multi-Project Store tracks cross-project user patterns
```

### **Memory Persistence Levels**
1. **Conversation Level** - unified_conversation_memory
2. **Project Level** - project_contexts table
3. **User Level** - user_memories table (cross-project)
4. **Session Level** - Universal Session Manager cache

---

## üîë KEY INTEGRATION POINTS

### **Session ID as Join Key**
- **Primary Join**: `metadata->>'session_id'` in unified_conversations
- **Used by**: CIA, IRIS, COIA agents for conversation continuity
- **Cross-Agent**: Enables CIA ‚Üí IRIS ‚Üí COIA conversation sharing

### **Universal Session Manager**
- **Used by**: ALL agents for consistent memory persistence
- **Methods**: `get_or_create_session()`, `save_messages_direct()`
- **Cache**: In-memory + database persistence

### **LangGraph Integration** 
- **Class**: `ProjectAwareAgentConfig`
- **Method**: `initialize_agent_context()` - loads cross-project context
- **Use**: Called before agent processing for memory-aware responses

---

## üöÄ SYSTEM CAPABILITIES

### **Cross-Project Memory**
- User budget preferences tracked across multiple projects
- Communication style patterns remembered
- Project relationships understood ("add to lawn maintenance project")

### **Agent Continuity**
- CIA extracts project details ‚Üí IRIS provides design inspiration ‚Üí COIA handles contractor bidding
- Full conversation context available to each agent
- Memory persists across sessions and agent switches

### **Multi-Party Conversations**
- Homeowner ‚Üî Contractor messaging through unified system
- Read/unread status tracking via `unified_conversation_participants`
- Message threading support via `parent_id` relationships

### **Rich Attachments**
- Image/document support via `unified_message_attachments`
- Metadata storage for file types, sizes, processing status
- Integration with InstaBids photo storage system

---

## üîß CURRENT STATUS & HEALTH

### **‚úÖ Fully Operational Components**
- Multi-project memory store
- Universal session manager  
- CIA unified integration
- IRIS unified chat system
- Database schema complete
- Cross-agent adapters working

### **üöß In Development**
- COIA unified integration (multiple versions being tested)
- Image attachment consolidation 
- Message threading UI components
- Cross-agent notification system

### **‚ö†Ô∏è Known Issues** 
- Parallel messaging stacks (legacy vs unified)
- Attachment table duplication (message_attachments vs unified_message_attachments)
- Some agents still using old conversation system

---

## üéØ BUSINESS VALUE

### **For Users**
- **Seamless Experience**: No need to repeat information across agents
- **Project Awareness**: System remembers relationships between projects
- **Persistent Memory**: Conversations continue exactly where they left off

### **For Developers** 
- **Unified API**: Single system for all agent memory needs
- **Cross-Agent Context**: Rich context sharing between agents
- **Scalable Architecture**: Supports unlimited projects and conversations

### **For Platform**
- **Data Consistency**: Single source of truth for all conversations
- **Analytics Ready**: Rich metadata for conversation analysis
- **Privacy Compliant**: Built-in privacy filtering and access controls

---

## üìã NEXT STEPS FOR AGENTS

### **For New Agent Development**
1. Use `UniversalSessionManager` for all conversation persistence
2. Query `unified_conversations` by session_id for context
3. Save messages to `unified_messages` with rich metadata
4. Use adapters for cross-agent context (privacy-filtered)

### **For Existing Agent Migration**
1. Replace agent-specific memory with `universal_session_manager.py`
2. Update database queries to use unified_* tables
3. Test cross-agent conversation continuity
4. Implement privacy filtering via adapters

### **For Frontend Integration**
1. Connect to `/api/unified-conversation` endpoints
2. Use session_id for conversation continuity
3. Implement real-time updates via unified table WebSockets
4. Support rich message types and attachments

---

**üß† The unified memory system is the BRAIN of InstaBids - enabling true multi-agent conversation intelligence with persistent, cross-project awareness.**