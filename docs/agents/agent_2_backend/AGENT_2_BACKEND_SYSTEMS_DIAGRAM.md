# Agent 2: Backend Core - Systems Interconnection Diagram
**Last Updated**: January 30, 2025  
**Agent**: Backend Core (Claude Code)  
**Purpose**: Visual representation of how all my backend systems connect and interact

## 🏗️ **SYSTEM ARCHITECTURE OVERVIEW**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           AGENT 2: BACKEND CORE SYSTEMS                        │
│                                                                                 │
│  ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  │
│  ┃                            INPUT BOUNDARY                                  ┃  │
│  ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  │
│                                      ▲                                         │
│                                      │                                         │
│                         FROM AGENT 1 (Frontend Flow)                          │
│                              │                                                 │
│                              ▼                                                 │
│                      ┌─────────────────┐                                      │
│                      │   BID CARDS     │◄──── Generated by JAA Agent         │
│                      │   (Input Data)  │                                      │
│                      └─────────────────┘                                      │
│                              │                                                 │
│                              ▼                                                 │
│                                                                                 │
│  ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  │
│  ┃                         PROCESSING LAYER                                  ┃  │
│  ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐            │
│  │      CDA        │    │      EAA        │    │      WFA        │            │
│  │   CONTRACTOR    │    │   EXTERNAL      │    │   WEBSITE       │            │
│  │   DISCOVERY     │    │  ACQUISITION    │    │     FORM        │            │
│  │     AGENT       │    │     AGENT       │    │  AUTOMATION     │            │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘            │
│          │                       │                       │                    │
│          ▼                       ▼                       ▼                    │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐            │
│  │   DISCOVERY     │    │   OUTREACH      │    │   FORM FILLING  │            │
│  │   PROCESSING    │    │   CAMPAIGNS     │    │   & SUBMISSION  │            │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘            │
│                                                                                 │
│  ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  │
│  ┃                      ORCHESTRATION LAYER                                  ┃  │
│  ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐            │
│  │     TIMING      │    │   CHECK-IN      │    │   ENHANCED      │            │
│  │  & PROBABILITY  │    │    MANAGER      │    │   CAMPAIGN      │            │
│  │     ENGINE      │    │                 │    │ ORCHESTRATOR    │            │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘            │
│                                                                                 │
│  ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  │
│  ┃                        MONITORING LAYER                                   ┃  │
│  ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐            │
│  │   RESPONSE      │    │    FOLLOW-UP    │    │   ENRICHMENT    │            │
│  │   MONITORING    │    │   AUTOMATION    │    │     AGENTS      │            │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘            │
│                                                                                 │
│  ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  │
│  ┃                          OUTPUT BOUNDARY                                  ┃  │
│  ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  │
│                              │                                                 │
│                              ▼                                                 │
│                    ┌─────────────────┐                                        │
│                    │  CONTRACTOR     │                                        │
│                    │   RESPONSES     │                                        │
│                    │   & BID CARDS   │                                        │
│                    └─────────────────┘                                        │
│                              │                                                 │
│                              ▼                                                 │
│                    TO AGENT 3 (Homeowner UX)                                  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 **DETAILED SYSTEM INTERCONNECTIONS**

### **1. CDA (CONTRACTOR DISCOVERY AGENT)** 🔍

**Input Sources**:
```
bid_cards table → project_type, location, budget_range, urgency_level
```

**Processing Components**:
```
┌─────────────────────────────────────────┐
│              CDA SYSTEM                 │
├─────────────────────────────────────────┤
│ ┌─────────────────┐ ┌─────────────────┐ │
│ │   agent_v2.py   │ │intelligent_     │ │
│ │   (Enhanced)    │ │matcher.py       │ │
│ │                 │ │(Claude Opus 4)  │ │
│ └─────────────────┘ └─────────────────┘ │
│           │                   │         │
│           ▼                   ▼         │
│ ┌─────────────────┐ ┌─────────────────┐ │
│ │email_discovery_ │ │web_search_      │ │
│ │agent.py         │ │agent.py         │ │
│ └─────────────────┘ └─────────────────┘ │
│           │                   │         │
│           ▼                   ▼         │
│ ┌─────────────────┐ ┌─────────────────┐ │
│ │tier1_matcher.py │ │tier2_reengag-   │ │
│ │                 │ │ement.py         │ │
│ └─────────────────┘ └─────────────────┘ │
│                             │           │
│                             ▼           │
│                   ┌─────────────────┐   │
│                   │tier3_scraper.py │   │
│                   └─────────────────┘   │
└─────────────────────────────────────────┘
```

**Output Data**:
```
contractor_leads → 50 columns of contractor data
discovery_runs → Audit trail and performance metrics
contractor_discovery_cache → Performance optimization
```

**Connections to Other Systems**:
- **→ EAA**: contractor_leads feed outreach campaigns
- **→ Enrichment**: Websites discovered for enrichment
- **→ Database**: All tables updated with discovery results

---

### **2. EAA (EXTERNAL ACQUISITION AGENT)** 📧

**Input Sources**:
```
contractor_leads → From CDA discovery
bid_cards → Project details for messaging
message_templates → Outreach templates
```

**Processing Components**:
```
┌─────────────────────────────────────────┐
│              EAA SYSTEM                 │
├─────────────────────────────────────────┤
│ ┌─────────────────┐                     │
│ │   agent.py      │                     │
│ │ (Orchestrator)  │                     │
│ └─────────────────┘                     │
│           │                             │
│           ▼                             │
│ ┌─────────────────┐ ┌─────────────────┐ │
│ │message_         │ │outreach_        │ │
│ │templates/       │ │channels/        │ │
│ └─────────────────┘ └─────────────────┘ │
│           │                   │         │
│           ▼                   ▼         │
│ ┌─────────────────┐ ┌─────────────────┐ │
│ │onboarding_flow/ │ │response_        │ │
│ │                 │ │tracking/        │ │
│ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────┘
```

**Output Data**:
```
outreach_campaigns → Campaign orchestration
contractor_outreach_attempts → Detailed outreach tracking (40 columns)
campaign_contractors → Campaign-contractor relationships
```

**Connections to Other Systems**:
- **← CDA**: Receives discovered contractors
- **→ WFA**: Triggers website form automation
- **→ Response Monitor**: Feeds response tracking
- **→ Follow-up**: Triggers follow-up sequences

---

### **3. WFA (WEBSITE FORM AUTOMATION)** 🤖

**Input Sources**:
```
contractor_leads → Website URLs and form_fields data
bid_cards → Project data to fill forms
contractor_outreach_attempts → Outreach context
```

**Processing Components**:
```
┌─────────────────────────────────────────┐
│              WFA SYSTEM                 │
├─────────────────────────────────────────┤
│ ┌─────────────────┐                     │
│ │   agent.py      │                     │
│ │ (Playwright)    │                     │
│ └─────────────────┘                     │
│           │                             │
│           ▼                             │
│ ┌─────────────────┐ ┌─────────────────┐ │
│ │Form Detection   │ │Field Mapping    │ │
│ │Engine           │ │Algorithm        │ │
│ └─────────────────┘ └─────────────────┘ │
│           │                   │         │
│           ▼                   ▼         │
│ ┌─────────────────┐ ┌─────────────────┐ │
│ │Form Filling     │ │Submission       │ │
│ │Automation       │ │Tracking         │ │
│ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────┘
```

**Output Data**:
```
contractor_outreach_attempts → form_submission_success updated
contractor_leads → form_fields and last_form_submission updated
```

**Connections to Other Systems**:
- **← EAA**: Triggered by outreach campaigns
- **→ Response Monitor**: Form submissions tracked
- **→ Database**: Updates outreach attempt status

---

### **4. ORCHESTRATION SYSTEM** ⏰

**Components & Data Flow**:
```
┌───────────────────────────────────────────────────────────────┐
│                   ORCHESTRATION SYSTEM                       │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────┐    ┌─────────────────┐                  │
│  │     TIMING      │    │   CHECK-IN      │                  │
│  │ & PROBABILITY   │◄──►│    MANAGER      │                  │
│  │    ENGINE       │    │                 │                  │
│  └─────────────────┘    └─────────────────┘                  │
│           │                       │                          │
│           ▼                       ▼                          │
│  ┌─────────────────────────────────────────┐                 │
│  │         ENHANCED CAMPAIGN               │                 │
│  │          ORCHESTRATOR                   │                 │
│  │                                         │                 │
│  │  • Integrates timing calculations       │                 │
│  │  • Schedules check-ins                  │                 │
│  │  • Manages escalations                  │                 │
│  │  • Coordinates all backend agents       │                 │
│  └─────────────────────────────────────────┘                 │
└───────────────────────────────────────────────────────────────┘
```

**Mathematical Business Logic**:
```
INPUT: User needs 4 bids in 6 hours (URGENT)

TIMING ENGINE CALCULATES:
├─ Tier 1 (90% response): 3 contractors → 2.7 expected responses
├─ Tier 2 (50% response): 5 contractors → 2.5 expected responses  
├─ Tier 3 (33% response): 0 contractors → 0 expected responses
└─ TOTAL: 8 contractors → 5.2 expected responses ✅ Exceeds target

CHECK-IN SCHEDULE:
├─ 1.5 hours: How many responses? Launch wave 2 if < 2
├─ 3.0 hours: How many responses? Launch wave 3 if < 3
└─ 4.5 hours: How many responses? Escalate if < 4
```

**Connections to All Systems**:
- **→ CDA**: Triggers contractor discovery waves
- **→ EAA**: Orchestrates outreach campaigns
- **→ WFA**: Coordinates form automation
- **→ Database**: Updates campaign status and timing

---

### **5. MONITORING & RESPONSE SYSTEM** 📊

**Components**:
```
┌─────────────────────────────────────────┐
│           MONITORING SYSTEM             │
├─────────────────────────────────────────┤
│ ┌─────────────────┐                     │
│ │   RESPONSE      │                     │
│ │   MONITORING    │                     │
│ │                 │                     │
│ │ • Hot lead      │                     │
│ │   detection     │                     │
│ │ • Sentiment     │                     │
│ │   analysis      │                     │
│ │ • Response      │                     │
│ │   categorization│                     │
│ └─────────────────┘                     │
│           │                             │
│           ▼                             │
│ ┌─────────────────┐ ┌─────────────────┐ │
│ │   FOLLOW-UP     │ │   ENRICHMENT    │ │
│ │   AUTOMATION    │ │     AGENTS      │ │
│ │                 │ │                 │ │
│ │ • Auto follow-  │ │ • Website data  │ │
│ │   up sequences  │ │   extraction    │ │
│ │ • Escalation    │ │ • Contact form  │ │
│ │   triggers      │ │   discovery     │ │
│ │ • Response      │ │ • Profile       │ │
│ │   tracking      │ │   enhancement   │ │
│ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────┘
```

**Data Processing**:
```
contractor_responses → Hot lead detection → followup_attempts
email_tracking_events → Engagement analysis → contractor_engagement_summary
contractor_leads → Website enrichment → enrichment_data updated
```

---

## 🗄️ **DATABASE INTERCONNECTION MAP**

### **Primary Data Flow Through Tables**:
```
1. bid_cards (INPUT)
   │
   ├─► contractor_leads (CDA discoveries)
   │   │
   │   ├─► discovery_runs (CDA audit trail)
   │   │
   │   ├─► contractor_discovery_cache (CDA optimization)
   │   │
   │   └─► contractor_engagement_summary (Analytics)
   │
   ├─► outreach_campaigns (EAA orchestration)
   │   │
   │   ├─► campaign_contractors (Campaign-contractor links)
   │   │
   │   └─► contractor_outreach_attempts (Detailed tracking)
   │
   ├─► contractor_responses (Response processing)
   │   │
   │   ├─► response_events (Response lifecycle)
   │   │
   │   └─► followup_attempts (Automated follow-up)
   │
   └─► followup_logs (Audit trail)
```

### **Cross-Reference Relationships**:
```
contractor_leads.id ←→ contractor_outreach_attempts.contractor_lead_id
contractor_leads.id ←→ contractor_responses.contractor_id
contractor_leads.id ←→ followup_attempts.contractor_id
bid_cards.id ←→ outreach_campaigns.bid_card_id
bid_cards.id ←→ contractor_responses.bid_card_id
outreach_campaigns.id ←→ campaign_contractors.campaign_id
```

---

## 🚀 **API INTEGRATION LAYER**

### **My FastAPI Endpoints** (Port 8003):
```
┌─────────────────────────────────────────┐
│           API ENDPOINTS                 │
├─────────────────────────────────────────┤
│                                         │
│  POST /api/cda/discover                 │
│  │ • Triggers contractor discovery      │
│  │ • Returns contractor_leads           │
│  │                                      │
│  POST /api/eaa/campaign                 │
│  │ • Creates outreach campaign          │
│  │ • Returns campaign status            │
│  │                                      │
│  POST /api/wfa/automate                 │
│  │ • Triggers form automation           │
│  │ • Returns submission results         │
│  │                                      │
│  GET /api/orchestration/status          │
│  │ • Returns timing system status       │
│  │ • Shows campaign progress            │
│  │                                      │
│  GET /api/responses/hot-leads           │
│  │ • Returns hot lead analysis          │
│  │ • Provides follow-up recommendations │
│                                         │
└─────────────────────────────────────────┘
```

### **External API Dependencies**:
```
Claude Opus 4 API ←── CDA intelligent matching
Google Maps API ←── CDA contractor discovery  
Email Service APIs ←── EAA outreach delivery
SMS Service APIs ←── EAA SMS outreach
Playwright/Chrome ←── WFA form automation
```

---

## 📈 **PERFORMANCE & OPTIMIZATION**

### **Caching Strategy**:
```
contractor_discovery_cache → Avoids re-running expensive discovery
contractor_engagement_summary → Pre-computed analytics
Google Maps results → Cached for repeated searches
```

### **Async Processing**:
```
CDA Discovery: Parallel contractor searches across multiple sources
EAA Outreach: Concurrent email/SMS delivery  
WFA Automation: Parallel form processing
Response Monitoring: Real-time response processing
```

### **Database Optimization**:
```
Indexed foreign keys for fast lookups
JSONB indexes for complex queries
Connection pooling via Supabase
Batch operations for bulk data processing
```

---

## 🚨 **SYSTEM HEALTH MONITORING**

### **Key Metrics I Track**:
```
CDA Performance: Contractors discovered per second
EAA Delivery: Outreach success rate by channel
WFA Success: Form submission success rate
Response Rate: Hot lead detection accuracy
Database: Query performance and connection health
```

### **Alert Conditions**:
```
CDA: <5 contractors found for any bid card
EAA: <80% outreach delivery success
WFA: <60% form submission success  
Timing: Check-ins missed or escalations triggered
Database: Query times >2 seconds
```

---

**This diagram represents the complete interconnection of all my backend systems. Every arrow, connection, and data flow shown here is implemented and functional in the current system.**