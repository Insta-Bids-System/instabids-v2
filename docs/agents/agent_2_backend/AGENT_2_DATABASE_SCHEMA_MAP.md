# Agent 2: Backend Core - Complete Database Schema Map
**Last Updated**: January 30, 2025  
**Agent**: Backend Core (Claude Code)  
**Purpose**: Map every Supabase table I interact with and their relationships

## 📊 **DATABASE REALITY CHECK** (Actual vs Aspirational)

### **✅ TABLES THAT EXIST** (Confirmed in Supabase)
Total: 45 tables found in database (not the documented 33)

#### **📋 MY PRIMARY WORKING TABLES** (Direct Use)

**1. bid_cards** ✅ REAL - My main input from JAA
```sql
-- Fields: 13 columns
- id (uuid, PRIMARY KEY)
- cia_thread_id (varchar) - Links to Agent 1's conversations  
- bid_card_number (varchar, UNIQUE) - Generated by JAA
- project_type (varchar) - kitchen, lawn, bathroom, etc.
- urgency_level (varchar) - emergency/week/month/flexible
- complexity_score (integer) - 1-10 scoring
- contractor_count_needed (integer) - Target contractor count
- budget_min, budget_max (integer) - Budget range
- bid_document (jsonb) - Complete bid card data from JAA
- requirements_extracted (jsonb) - Structured requirements
- status (varchar) - generated/processing/complete
- created_at, updated_at (timestamp)
```

**2. contractor_leads** ✅ REAL - CDA discovers and stores here
```sql
-- Fields: 50 columns (comprehensive contractor data)
- id (uuid, PRIMARY KEY)
- source (USER-DEFINED) - tier1/tier2/tier3
- company_name (varchar, NOT NULL)
- contact_name, phone, email, website (varchar)
- address, city, state, zip_code (varchar)
- latitude, longitude (numeric) - GPS coordinates
- service_radius_miles (integer)
- specialties (ARRAY) - Service types
- rating, review_count (numeric, integer)
- license_number, license_verified (varchar, boolean)
- lead_score, data_completeness (integer)
- has_contact_form, contact_form_url (boolean, text)
- form_fields (jsonb) - For WFA agent
- lead_status (USER-DEFINED) - qualified/disqualified/pending
- created_at, updated_at, last_enriched_at (timestamp)
```

**3. outreach_campaigns** ✅ REAL - EAA creates and manages
```sql
-- Fields: 17 columns
- id (uuid, PRIMARY KEY)  
- bid_card_id (uuid, FOREIGN KEY → bid_cards)
- name, description (text)
- target_criteria (jsonb) - Contractor selection criteria
- max_contractors (integer)
- scheduled_start, actual_start, completed_at (timestamp)
- status (varchar) - draft/active/completed/paused
- contractors_targeted, messages_sent (integer)
- responses_received, hot_leads_generated (integer)
- created_at, updated_at (timestamp)
```

**4. contractor_outreach_attempts** ✅ REAL - EAA tracks all outreach
```sql
-- Fields: 40 columns (comprehensive outreach tracking)
- id (uuid, PRIMARY KEY)
- contractor_lead_id (uuid, FOREIGN KEY → contractor_leads)
- bid_card_id (uuid, FOREIGN KEY → bid_cards)
- campaign_id (uuid, FOREIGN KEY → outreach_campaigns)
- channel (USER-DEFINED) - email/sms/website_form/phone
- message_template_id, message_subject, message_content (text)
- form_url, form_fields_filled (text, jsonb) - WFA data
- sent_at, delivered_at, opened_at, clicked_at (timestamp)
- responded_at, response_channel, response_content (timestamp, varchar, text)
- status (USER-DEFINED) - sent/delivered/opened/clicked/responded/failed
- error_code, error_message (varchar, text)
- cost_cents (integer) - Outreach cost tracking
- created_at, updated_at (timestamp)
```

**5. contractor_responses** ✅ REAL - Response monitoring data
```sql
-- Fields: 20 columns
- id (uuid, PRIMARY KEY)
- contractor_id (uuid, FOREIGN KEY → contractor_leads)
- bid_card_id (uuid, FOREIGN KEY → bid_cards)
- response_type, response_channel (varchar)
- message (text, NOT NULL) - Response content
- sentiment (varchar) - positive/negative/neutral
- interest_level (integer) - 1-10 scale
- is_hot_lead, hot_lead_score (boolean, numeric)
- hot_lead_reasons (jsonb) - AI analysis results
- received_at, processed_at, created_at (timestamp)
```

**6. followup_attempts** ✅ REAL - My follow-up tracking
```sql
-- Fields: 15 columns
- id (uuid, PRIMARY KEY)
- contractor_id (uuid, FOREIGN KEY → contractor_leads)
- bid_card_id (uuid, FOREIGN KEY → bid_cards)  
- attempt_number (integer) - 1st, 2nd, 3rd attempt
- channel (varchar) - email/sms/phone
- message (text) - Follow-up content
- status (varchar) - sent/delivered/failed
- sent_at, delivered_at, failed_at (timestamp)
- got_response, response_received_at (boolean, timestamp)
- created_at (timestamp)
```

**7. followup_logs** ✅ REAL - Automation audit trail
```sql
-- Fields: 9 columns
- id (uuid, PRIMARY KEY)
- log_type (varchar) - info/warning/error
- contractor_id (uuid) - Related contractor
- bid_card_id (uuid) - Related bid card
- message (text, NOT NULL) - Log message
- details (jsonb) - Additional context
- is_error, error_code (boolean, varchar)
- created_at (timestamp)
```

#### **📊 MY SUPPORTING/CACHE TABLES** (Performance & Tracking)

**8. contractor_discovery_cache** ✅ REAL - CDA performance optimization
```sql
-- Fields: 8 columns
- id (uuid, PRIMARY KEY)
- bid_card_id (uuid, FOREIGN KEY → bid_cards)
- tier_1_matches, tier_2_matches, tier_3_sources (jsonb)
- discovery_status (varchar) - running/complete/failed
- total_contractors_found, processing_time_ms (integer)
- created_at (timestamp)
```

**9. discovery_runs** ✅ REAL - CDA execution tracking
```sql
-- Fields: 22 columns
- id (uuid, PRIMARY KEY)
- bid_card_id (uuid, FOREIGN KEY → bid_cards)
- search_parameters (jsonb) - CDA search criteria
- location, radius_miles, project_type (varchar, integer, varchar)
- target_count, total_found, qualified_count (integer)
- started_at, completed_at, duration_seconds (timestamp, integer)
- status (varchar) - running/complete/failed
- current_source (USER-DEFINED) - Which source being searched
- error_message, error_details (text, jsonb)
```

**10. contractor_engagement_summary** ✅ REAL - Analytics powerhouse
```sql
-- Fields: 42 columns (comprehensive engagement metrics)
- contractor_lead_id (uuid, PRIMARY KEY, FOREIGN KEY)
- first_contacted_at, last_contacted_at, last_responded_at (timestamp)
- total_outreach_count, email_sent_count, sms_sent_count (integer)
- email_opened_count, email_clicked_count (integer)
- total_responses, positive_responses, negative_responses (integer)
- engagement_score, responsiveness_score (numeric)
- preferred_contact_channel (USER-DEFINED)
- opt_out_email, opt_out_sms, opt_out_all (boolean)
- cost_per_response_cents (integer)
- created_at, updated_at (timestamp)
```

#### **🔗 SHARED TABLES** (Coordinate with Other Agents)

**11. agent_conversations** 🤝 Agent 1 creates, I read for context
```sql
-- Fields: 8 columns
- id (uuid, PRIMARY KEY)
- user_id (uuid) - Homeowner ID
- agent_type (text) - 'cia', 'jaa', etc.
- thread_id (text) - Session identifier
- state (jsonb) - Conversation state
- last_message (text)
- created_at, updated_at (timestamp)
```

**12. homeowners** 🤝 Agent 3 manages, I reference
```sql
-- Fields: 7 columns
- id (uuid, PRIMARY KEY)
- user_id (uuid) - Auth user ID
- address, preferences (jsonb)
- total_projects, total_spent (integer, numeric)
- created_at (timestamp)
```

**13. projects** 🤝 Agent 1 creates, I use for context
```sql
-- Fields: 15 columns  
- id (uuid, PRIMARY KEY)
- homeowner_id (uuid, FOREIGN KEY → homeowners)
- title, description, category (text)
- urgency (USER-DEFINED)
- budget_range, location (jsonb)
- status (USER-DEFINED)
- cia_conversation_id (text) - Links to Agent 1
- created_at, updated_at, posted_at (timestamp)
```

### **❌ TABLES THAT DON'T EXIST** (Mentioned in 33-table docs but missing)

These were aspirational or misnamed in documentation:
```sql
conversation_states              ❌ NOT FOUND (docs said it existed)
contractor_leads_old             ❌ NOT FOUND (old table name?)
bid_card_distributions_old       ❌ NOT FOUND (old schema?)
project_intake_sessions          ❌ NOT FOUND (never created)
```

### **⚠️ COMPLEX TABLES** (High Column Count - Handle Carefully)

**contractor_leads**: 50 columns - Comprehensive contractor profiles
**contractor_outreach_attempts**: 40 columns - Detailed outreach tracking  
**contractor_engagement_summary**: 42 columns - Complete analytics data

---

## 🔄 **MY DATA FLOW PATTERNS** (How Tables Connect)

### **Core Pipeline Flow**
```
1. Agent 1 → agent_conversations (CIA conversations)
              ↓
2. Agent 1 → bid_cards (JAA generates from conversations)
              ↓
3. CDA → contractor_leads (discovers contractors)
              ↓  
4. CDA → discovery_runs (tracks discovery process)
              ↓
5. EAA → outreach_campaigns (creates outreach strategy)
              ↓
6. EAA → contractor_outreach_attempts (executes outreach)
              ↓
7. Response Monitor → contractor_responses (processes responses)
              ↓
8. Follow-up → followup_attempts (automated re-engagement)
```

### **Supporting Data Flows**
```
Performance: contractor_discovery_cache (CDA optimization)
Analytics: contractor_engagement_summary (metrics aggregation)
Logging: followup_logs (audit trail)
```

---

## 🎯 **TABLE RELATIONSHIPS** (Foreign Keys I Use)

### **Primary Relationships**
- **bid_cards.id** → outreach_campaigns.bid_card_id (1:many)
- **contractor_leads.id** → contractor_outreach_attempts.contractor_lead_id (1:many)
- **outreach_campaigns.id** → contractor_outreach_attempts.campaign_id (1:many)
- **contractor_leads.id** → contractor_responses.contractor_id (1:many)
- **bid_cards.id** → contractor_responses.bid_card_id (1:many)

### **Cross-Agent Relationships**
- **agent_conversations.thread_id** → bid_cards.cia_thread_id (Agent 1 → My domain)
- **homeowners.id** → projects.homeowner_id (Agent 3 ↔ Shared)
- **projects.id** → bid_cards.project_id (if implemented)

---

## 🚨 **CRITICAL OBSERVATIONS**

### **Database is More Complex Than Docs**
- **Real**: 45 tables found in database
- **Documented**: 33 tables claimed
- **Gap**: 12 additional tables exist that weren't documented

### **My Tables Are Production-Ready**
- All tables have proper UUID primary keys ✅
- Foreign key relationships properly defined ✅
- JSONB fields for complex data ✅
- Comprehensive tracking fields ✅
- Timestamp audit trails ✅

### **High Data Fidelity**
- contractor_leads: 50 columns of contractor data
- contractor_outreach_attempts: 40 columns of outreach tracking
- contractor_engagement_summary: 42 columns of analytics

### **Missing Tables are Aspirational**
- Tables mentioned in docs but not in database
- Likely never implemented or renamed
- Current schema is working reality

---

## 📈 **OPTIMIZATION OPPORTUNITIES**

### **Indexing Strategy**
```sql
-- High-frequency lookups
CREATE INDEX idx_contractor_leads_source ON contractor_leads(source);
CREATE INDEX idx_outreach_attempts_status ON contractor_outreach_attempts(status);
CREATE INDEX idx_bid_cards_urgency ON bid_cards(urgency_level);
CREATE INDEX idx_contractor_responses_hot_lead ON contractor_responses(is_hot_lead);
```

### **Query Patterns I Use**
1. **Find contractors for bid card**: contractor_leads WHERE specialties @> project_type
2. **Track outreach status**: contractor_outreach_attempts WHERE bid_card_id = ? AND status = ?
3. **Hot lead detection**: contractor_responses WHERE is_hot_lead = true
4. **Follow-up scheduling**: followup_attempts WHERE attempt_number < 3 AND got_response = false

---

## 🔧 **TECHNICAL STACK INTEGRATION**

### **Data Types I Handle**
- **JSONB**: Complex data structures (bid_documents, search_parameters, etc.)
- **ARRAY**: Lists (specialties, service_zip_codes, etc.)
- **UUID**: All primary/foreign keys
- **USER-DEFINED**: Enums (source, status, sentiment, etc.)
- **Timestamp**: Both with/without timezone

### **My Database Libraries**
- **Supabase Python Client**: Main connection via database_simple.py
- **AsyncIO**: For concurrent database operations
- **JSONB Operations**: Complex data queries and updates

---

**This schema map represents the ACTUAL database structure I work with, not aspirational documentation. Every table listed here exists and is actively used in my backend systems.**